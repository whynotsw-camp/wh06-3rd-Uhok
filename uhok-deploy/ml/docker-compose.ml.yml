services:
  ml-inference:
    build:
      context: ../../uhok-ml-inference
      dockerfile: Dockerfile
    image: uhok-ml-inference:1.2.0
    user: "1000:1000"  # ì‹¤í–‰ ì‚¬ìš©ì ëª…ì‹œ (appuser) (PermissionError ë°©ì§€)
    environment:
      - HF_HOME=/models/hf_cache
      - TRANSFORMERS_CACHE=/models/hf_cache
      - SENTENCE_TRANSFORMERS_HOME=/models/hf_cache
      - PYTHONUNBUFFERED=1
    volumes:
      - ml_cache:/models/hf_cache   # ë„¤ì„ë“œ ë³¼ë¥¨ -> ì»¨í…Œì´ë„ˆ ê²½ë¡œ ë§¤í•‘
      # - /data/models:/models:ro   # ëª¨ë¸ ê°€ì¤‘ì¹˜ëŠ” ì´ë¯¸ì§€ì— ë„£ì§€ ë§ê³  ë³¼ë¥¨/ë§ˆìš´íŠ¸ ê¶Œì¥
    ports:
      - "8001:8001"   # localhost:8001ë¡œ ì ‘ê·¼ ê°€ëŠ¥
    expose:
      - "8001"   # ë‚´ë¶€ í†µì‹ ë„ ìœ ì§€
    healthcheck:
      # ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ì— ë§ì¶° /health ë˜ëŠ” /healthz ë¡œ ë³€ê²½
      test: ["CMD-SHELL", "curl -fsS http://localhost:8001/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 180s
      retries: 3
    # ğŸ”§ ë„¤íŠ¸ì›Œí¬ ì„¤ì • (í™˜ê²½ë³„ ì£¼ì„ ì²˜ë¦¬)
    # EC2: ì£¼ì„ ì²˜ë¦¬ (ë…ë¦½ ì‹¤í–‰)
    # ë¡œì»¬: ì£¼ì„ í•´ì œ (ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì™€ í†µì‹ )
    networks: [uhok_net]
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

volumes:
  ml_cache:

# ğŸ”§ ë„¤íŠ¸ì›Œí¬ ì •ì˜ (í™˜ê²½ë³„ ì£¼ì„ ì²˜ë¦¬)
# EC2: ì „ì²´ ì£¼ì„ ì²˜ë¦¬
# ë¡œì»¬: ì£¼ì„ í•´ì œí•˜ì—¬ uhok_net ë„¤íŠ¸ì›Œí¬ ìƒì„±
networks:
  uhok_net:
    external: true
    